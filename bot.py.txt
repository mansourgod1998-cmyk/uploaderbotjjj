import asyncio
from aiogram import Bot, Dispatcher, types, F
from aiogram.filters import Command
from aiogram.types import InlineKeyboardMarkup, InlineKeyboardButton, CallbackQuery
from config import BOT_TOKEN, ADMIN_ID
import database as db

bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()

async def check_subscriptions(user_id):
    channels = await db.list_channels()
    not_joined = []
    for ch in channels:
        try:
            member = await bot.get_chat_member(ch, user_id)
            if member.status in ["left", "kicked"]:
                not_joined.append(ch)
        except:
            not_joined.append(ch)
    return not_joined

@dp.message(Command("start"))
async def start(message: types.Message):
    await message.answer("ğŸ¬ Ø³Ù„Ø§Ù…! Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ Ø®ÙˆØ¯Øª Ø±Ùˆ Ø¨ÙØ±Ø³Øª.\nØ§Ø¯Ù…ÛŒÙ† Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ø±Ùˆ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†Ù‡.")

@dp.message(Command("addchannel"))
async def add_channel(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        return
    parts = message.text.split()
    if len(parts) == 2:
        await db.add_channel(parts[1])
        await message.answer(f"âœ… Ú©Ø§Ù†Ø§Ù„ {parts[1]} Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯.")
    else:
        await message.answer("âŒ ÙØ±Ù…Øª Ø§Ø´ØªØ¨Ø§Ù‡. Ù…Ø«Ø§Ù„: /addchannel @channelname")

@dp.message(Command("removechannel"))
async def remove_channel(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        return
    parts = message.text.split()
    if len(parts) == 2:
        await db.remove_channel(parts[1])
        await message.answer(f"ğŸ—‘ï¸ Ú©Ø§Ù†Ø§Ù„ {parts[1]} Ø­Ø°Ù Ø´Ø¯.")
    else:
        await message.answer("âŒ ÙØ±Ù…Øª Ø§Ø´ØªØ¨Ø§Ù‡. Ù…Ø«Ø§Ù„: /removechannel @channelname")

@dp.message(Command("listchannels"))
async def list_channels(message: types.Message):
    channels = await db.list_channels()
    if channels:
        await message.answer("ğŸ“¢ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ:\n" + "\n".join(channels))
    else:
        await message.answer("Ù‡ÛŒÚ† Ú©Ø§Ù†Ø§Ù„ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡.")

@dp.message(Command("stats"))
async def stats(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        return
    files = await db.list_files()
    if not files:
        await message.answer("Ù‡Ù†ÙˆØ² ÙØ§ÛŒÙ„ÛŒ Ø¢Ù¾Ù„ÙˆØ¯ Ù†Ø´Ø¯Ù‡.")
        return
    text = "\n".join([f"ğŸ“ {f[1] or 'Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­'} â€” ğŸ‘ {f[2]} Ø¨Ø§Ø²Ø¯ÛŒØ¯" for f in files])
    await message.answer(f"ğŸ“Š Ø¢Ù…Ø§Ø± Ø¨Ø§Ø²Ø¯ÛŒØ¯:\n{text}")

@dp.message()
async def handle_files(message: types.Message):
    if message.from_user.id != ADMIN_ID:
        return
    if message.video or message.photo or message.document:
        file_id = (
            message.video.file_id if message.video else
            message.photo[-1].file_id if message.photo else
            message.document.file_id
        )
        caption = message.caption or "Ø¨Ø¯ÙˆÙ† ØªÙˆØ¶ÛŒØ­"
        await db.add_file(file_id, caption)
        files = await db.list_files()
        file_db_id = files[-1][0]
        await message.answer(f"âœ… ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯.\nğŸ“ Ù„ÛŒÙ†Ú© Ø§Ø®ØªØµØ§ØµÛŒ: `/watch_{file_db_id}`", parse_mode="Markdown")

@dp.message(F.text.startswith("/watch_"))
async def watch_file(message: types.Message):
    file_id = int(message.text.split("_")[1])
    not_joined = await check_subscriptions(message.from_user.id)

    if not_joined:
        kb = InlineKeyboardMarkup(inline_keyboard=[
            [InlineKeyboardButton(text=f"Ø¹Ø¶Ùˆ Ø´Ø¯Ù† Ø¯Ø± {ch}", url=f"https://t.me/{ch[1:]}")] for ch in not_joined
        ])
        kb.inline_keyboard.append([InlineKeyboardButton(text="âœ… Ø¹Ø¶Ùˆ Ø´Ø¯Ù…", callback_data=f"check_{file_id}")])
        await message.answer("âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø¹Ø¶Ùˆ Ø´Ùˆ Ùˆ Ø³Ù¾Ø³ Ø±ÙˆÛŒ Â«Ø¹Ø¶Ùˆ Ø´Ø¯Ù… âœ…Â» Ø¨Ø²Ù†:", reply_markup=kb)
        return

    await send_file(message.chat.id, file_id)

@dp.callback_query(F.data.startswith("check_"))
async def recheck_subscription(callback: CallbackQuery):
    file_id = int(callback.data.split("_")[1])
    not_joined = await check_subscriptions(callback.from_user.id)
    if not_joined:
        await callback.answer("Ù‡Ù†ÙˆØ² Ø¹Ø¶Ùˆ Ù‡Ù…Ù‡ Ú©Ø§Ù†Ø§Ù„â€ŒÙ‡Ø§ Ù†Ø´Ø¯ÛŒ âŒ", show_alert=True)
    else:
        await callback.answer("âœ… ØªØ§ÛŒÛŒØ¯ Ø´Ø¯! Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙØ§ÛŒÙ„...")
        await send_file(callback.from_user.id, file_id)

async def send_file(chat_id, file_id):
    data = await db.get_file(file_id)
    if not data:
        await bot.send_message(chat_id, "âŒ ÙØ§ÛŒÙ„ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.")
        return

    await db.increment_views(file_id)
    sent = await bot.send_video(chat_id, data[1], caption=data[2])
    await asyncio.sleep(30)
    await bot.delete_message(chat_id, sent.message_id)

async def main():
    await db.init_db()
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
